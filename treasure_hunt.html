<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
<title>Treasure Hunt!</title>
</head>

<body bgcolor="#CCCCCC">

<!--
####################################
###   Name:    Treasure Hunt!    ###
###   Author:  Brian Dumbacher   ###
####################################
-->

<!--
####################
###   Canvases   ###
####################

Background canvas
Foreground canvas
Cloud shadow canvas
Cloud canvas
Message canvas
-->

<div id="divCanvases" style="position: relative; border: 2px solid black; margin: 0 auto; width: 600px; height: 600px;">
<canvas id="canvasBG" style="z-index: 1; position: absolute; left: 0px; top: 0px;"></canvas>
<canvas id="canvasFG" style="z-index: 2; position: absolute; left: 0px; top: 0px;"></canvas>
<canvas id="canvasSG" style="z-index: 3; position: absolute; left: 0px; top: 0px;"></canvas>
<canvas id="canvasCG" style="z-index: 4; position: absolute; left: 0px; top: 0px;"></canvas>
<canvas id="canvasMG" style="z-index: 5; position: absolute; left: 0px; top: 0px;"></canvas>
</div>

<!--
#################
###   Audio   ###
#################

"Ahead on Our Way" obtained for free from https://downloads.khinsider.com/game-soundtracks/album/final-fantasy-vii-arranged-soundtrack-2016
"Hard shovel stab" and "Winning notification" sound effects obtained for free from https://mixkit.co/free-sound-effects/garden/ and converted to MP3 format using https://cloudconvert.com/wav-to-mp3
-->

<div id="divAudio" style="align-items: center; display: flex; justify-content: center; position: relative; margin: 0 auto; width: 600px;">
<audio id="audioMusic"  src="media/ahead_on_our_way.mp3" loop></audio>
<audio id="audioShovel" src="media/shovel.mp3"></audio>
<audio id="audioWin"    src="media/win.mp3"></audio>
</div>

<!--
########################
###   Instructions   ###
########################
-->

<div id="divInstruct" style="margin: 0 auto; text-align: left; width: 600px;">
<p id="textInstruct" style="font-family: arial;">You and your fellow townspeople are on the hunt for buried treasure.  Explore your world, talk to others, and pick up clues.  Use the arrow keys to move.  Use the space bar to interact with the environment and to dig for treasure.  Red visual cues indicate when you can interact, but you can dig anytime.  Press the space bar to begin your Treasure Hunt!</p>
</div>

<script type="text/javascript">

/*
##########################################
###   Global constants and variables   ###
##########################################
*/

// On-load function
window.onload = intro;

// Dimensions
const STAGE_DIM      = 600;
const NUM_TILES      = 20;
const TILE_DIM       = STAGE_DIM / NUM_TILES;
const PLAYER_DIM     = TILE_DIM/2;
const WORLD_WIDTH    = 2;
const WORLD_HEIGHT   = 3;
const FPS            = 60;
const NUM_CLOUDS     = 3;
const CLOUD_WIDTH    = 200;
const CLOUD_HEIGHT   = 100;
const MESSAGE_WIDTH  = 600;
const MESSAGE_HEIGHT = 200;

// Colors
const COL_BLACK       = "rgb(  0,   0,   0)";
const COL_BROWN_DARK  = "rgb( 90,  70,  10)";
const COL_BROWN_FENCE = "rgb(100, 100,  30)";
const COL_RED_ROOF    = "rgb(230, 100,  70)";
const COL_GRASS       = "rgb( 60, 220,  40)";
const COL_GRASS_DARK  = "rgb( 50, 160,  40)";
const COL_GREEN       = "rgb(  0, 255,   0)";
const COL_ORANGE      = "rgb(255, 160,   0)";
const COL_PATH        = "rgb(230, 230, 200)";
const COL_RED         = "rgb(255,   0,   0)";
const COL_SAND        = "rgb(255, 220,  90)";
const COL_TREE        = "rgb(  0,  90,   0)";
const COL_WHITE       = "rgb(255, 255, 255)";
const COL_YELLOW      = "rgb(255, 255,   0)";

// Images
var imgClouds;
var imgCloudShadow;
var imgGrass;
var imgIntro;
var imgMessages;
var imgMonument;
var imgShip;
var imgX;

// Game state, canvases, and other objects
var gameState;
var loopInterval;
var bg;
var fg;
var sg;
var cg;
var mg;
var tiles;
var player;
var clouds;
var message;
var world;

/*
###########################
###   Appearance maps   ###
###########################

be: Beach 
bf: Bridge over fresh water
bg: Building
bo: Bridge over ocean
e1: Estuary one
e2: Estuary two
e3: Estuary three
fe: Fence
fi: Field
fw: Fresh water
gr: Grass
hb: Brian's house
ho: House
lh: Lighthouse
mo: Monument
oc: Ocean
pa: Path
px: Path intersection 
sa: Sand
sf: Ship over fresh water
sg: Sandy grass
so: Ship over ocean
tr: Tree
xx: X marks the spot
*/

// Seaside forest
var appearanceMap_0_0 = [["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["oc_0", "e3_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "gr_0", "gr_0", "gr_0", "ho_0", "gr_0", "gr_0", "gr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "e3_0", "e3_0", "e3_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "e2_0", "tr_0", "tr_0", "e1_0", "e1_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["oc_0", "e3_0", "oc_0", "oc_0", "oc_0", "e3_0", "e3_0", "e3_0", "e2_0", "e1_0", "e1_0", "fw_0", "fw_0", "e1_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "e2_0", "e2_0", "e2_0", "e1_0", "e1_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "e3_0", "e3_0", "e3_0", "e2_0", "e1_0", "e1_0", "fw_0", "fw_0", "e1_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "e2_0", "e2_0", "e2_0", "e1_0", "e1_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["oc_0", "e3_0", "so_1", "so_2", "oc_0", "e3_0", "e3_0", "e3_0", "e2_0", "e1_0", "e1_0", "fw_0", "fw_0", "e1_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "e2_0", "e2_0", "e2_0", "e1_0", "e1_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "e3_0", "e3_0", "e3_0", "e2_0", "e1_0", "e1_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_6", "pa_2", "pa_2"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "e2_0", "e2_0", "e2_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "e3_0", "oc_0", "oc_0", "oc_0", "e3_0", "e3_0", "e3_0", "e2_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "oc_0", "e3_0", "e2_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "e3_0", "e3_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "e3_0", "oc_0", "gr_0", "gr_0", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_4", "tr_0", "tr_0"],
                         ["oc_0", "e3_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"]];

// River
var appearanceMap_0_1 = [["tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "tr_0", "ho_0", "ho_0", "bg_0", "ho_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_3", "gr_0", "gr_0", "gr_0", "tr_0", "gr_0", "tr_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "gr_0", "tr_0", "ho_0", "ho_0", "gr_0", "pa_1", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "sf_1", "sf_2", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "bf_1", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0"],
                         ["tr_0", "tr_0", "bg_0", "pa_1", "bg_0", "bg_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "bg_0", "ho_0", "pa_1", "ho_0", "tr_0", "tr_0"],
                         ["tr_0", "tr_0", "ho_0", "pa_1", "ho_0", "bg_0", "pa_1", "ho_0", "tr_0", "ho_0", "bg_0", "tr_0", "ho_0", "pa_1", "ho_0", "ho_0", "pa_1", "ho_0", "tr_0", "tr_0"],
                         ["pa_2", "pa_2", "pa_2", "px_1", "pa_2", "pa_2", "px_5", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_5", "pa_2", "pa_2", "pa_4", "tr_0", "tr_0", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "tr_0", "ho_0", "bg_0", "pa_1", "tr_0", "bg_0", "ho_0", "ho_0", "tr_0", "bg_0", "pa_1", "fe_6", "fe_2", "fe_2", "fe_2", "fe_3", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "tr_0", "pa_1", "bg_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "fe_1", "gr_0", "fw_0", "tr_0", "fe_1", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "ho_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "fe_1", "gr_0", "gr_0", "gr_0", "fe_1", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "pa_1", "ho_0", "gr_0", "tr_0", "gr_0", "pa_2", "pa_2", "px_5", "pa_2", "pa_2", "pa_2", "gr_0", "fe_1", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "ho_0", "pa_1", "tr_0", "gr_0", "fw_0", "gr_0", "gr_0", "tr_0", "pa_1", "fe_1", "tr_0", "ho_0", "tr_0", "fe_1", "tr_0"],
                         ["tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "bg_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "fe_1", "gr_0", "gr_0", "gr_0", "fe_1", "tr_0"],
                         ["tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "fe_1", "fi_0", "fi_0", "fi_0", "fe_1", "tr_0"],
                         ["tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "fe_5", "fe_2", "fe_2", "fe_2", "fe_4", "tr_0"]];

// Home
var appearanceMap_1_0 = [["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "pa_1", "fe_6", "fe_2"],
                         ["oc_0", "oc_0", "lh_0", "gr_0", "sg_4", "sg_5", "sg_6", "gr_0", "gr_0", "fi_0", "fi_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "tr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "gr_0", "gr_0", "oc_0", "be_7", "sg_7", "gr_0", "gr_0", "fi_0", "fi_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "sg_1", "sg_8", "gr_0", "gr_0", "fi_0", "fi_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "gr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "hb_0", "gr_0", "fw_0", "gr_0", "tr_0", "tr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_4", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "pa_1", "fe_5", "fe_2"],
                         ["oc_0", "tr_0", "gr_0", "bo_2", "bo_2", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "px_2", "pa_2", "pa_2"],
                         ["oc_0", "sg_4", "sg_5", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "gr_0", "gr_0", "tr_0", "gr_0", "gr_0", "gr_0", "pa_1", "fe_6", "fe_2"],
                         ["oc_0", "sg_3", "be_4", "oc_0", "oc_0", "be_7", "sa_0", "sg_7", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "be_7", "sa_0", "sg_7", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "be_7", "sa_0", "sg_7", "gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "be_7", "sa_0", "sg_7", "gr_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "fe_1", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "fw_0", "fw_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "fw_0", "fw_0", "fw_0", "fw_0", "fw_0", "gr_0", "pa_1", "fe_1", "fi_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "fw_0", "fw_0", "fw_0", "ho_0", "ho_0", "gr_0", "pa_1", "fe_5", "fe_2"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "tr_0", "tr_0"]];

// Town
var appearanceMap_1_1 = [["tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "bg_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fe_2", "fe_2", "fe_2", "fe_2", "fe_2", "fe_3", "pa_1", "fe_6", "fe_2", "fe_2", "fe_3", "tr_0", "tr_0", "pa_1", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["fi_0", "fi_0", "gr_0", "fi_0", "fi_0", "fe_1", "pa_1", "fe_1", "fw_0", "fw_0", "fe_1", "gr_0", "ho_0", "pa_1", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fi_0", "fi_0", "gr_0", "fi_0", "fi_0", "fe_1", "pa_1", "fe_1", "gr_0", "gr_0", "fe_1", "gr_0", "ho_0", "pa_1", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "tr_0"],
                         ["fi_0", "fi_0", "gr_0", "fi_0", "fi_0", "fe_1", "pa_1", "tr_0", "gr_0", "fi_0", "fe_1", "gr_0", "gr_0", "pa_1", "bg_0", "tr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fi_0", "fi_0", "gr_0", "fi_0", "fi_0", "fe_1", "pa_1", "ho_0", "gr_0", "fi_0", "fe_1", "gr_0", "tr_0", "pa_1", "ho_0", "tr_0", "gr_0", "xx_0", "gr_0", "tr_0"],
                         ["fi_0", "gr_0", "gr_0", "gr_0", "fi_0", "fe_1", "pa_1", "tr_0", "gr_0", "fi_0", "fe_1", "gr_0", "ho_0", "pa_1", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fi_0", "gr_0", "ho_0", "gr_0", "fi_0", "fe_1", "pa_1", "fe_1", "gr_0", "fi_0", "fe_1", "tr_0", "bg_0", "pa_1", "ho_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["fe_2", "fe_2", "pa_1", "fe_2", "fe_2", "fe_4", "pa_1", "fe_5", "fe_2", "fe_2", "fe_4", "ho_0", "pa_6", "px_1", "pa_3", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["pa_2", "pa_2", "px_1", "pa_2", "pa_2", "pa_2", "px_5", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_4", "gr_0", "pa_1", "fw_0", "fw_0", "mo_0", "gr_0", "tr_0"],
                         ["fe_2", "fe_2", "fe_2", "fe_2", "fe_2", "fe_3", "pa_1", "tr_0", "ho_0", "tr_0", "ho_0", "ho_0", "pa_5", "px_3", "pa_4", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fi_0", "fi_0", "fi_0", "fi_0", "fi_0", "fe_1", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "ho_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["fi_0", "fi_0", "fi_0", "fi_0", "fi_0", "fe_1", "pa_1", "ho_0", "gr_0", "tr_0", "tr_0", "gr_0", "bg_0", "pa_1", "bg_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["fi_0", "fi_0", "fi_0", "gr_0", "gr_0", "fe_1", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "bg_0", "gr_0", "ho_0", "gr_0", "tr_0", "tr_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_2", "px_5", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_5", "pa_2", "pa_2", "pa_2", "pa_2", "tr_0", "tr_0"],
                         ["fi_0", "fi_0", "fi_0", "gr_0", "gr_0", "fe_1", "pa_1", "ho_0", "tr_0", "bg_0", "ho_0", "tr_0", "bg_0", "pa_1", "tr_0", "ho_0", "tr_0", "ho_0", "tr_0", "tr_0"],
                         ["fi_0", "fi_0", "fi_0", "fi_0", "fi_0", "fe_1", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["fe_2", "fe_2", "fe_2", "fe_2", "fe_2", "fe_4", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "pa_1", "bg_0", "gr_0", "gr_0", "gr_0", "gr_0", "tr_0"]];

// Main island
var appearanceMap_2_0 = [["oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "be_7", "sg_7", "gr_0", "ho_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_6", "pa_2", "pa_2", "pa_2", "pa_2", "px_1", "pa_2", "pa_2"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "bo_1", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "bo_1", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "bo_1", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "oc_0", "oc_0", "bo_1", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "tr_0", "gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "pa_1", "gr_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "tr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "ho_0", "ho_0", "ho_0", "pa_1", "tr_0", "tr_0", "ho_0", "ho_0", "gr_0", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "tr_0", "pa_6", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_5", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "pa_1", "gr_0", "gr_0", "fw_0", "fw_0", "tr_0", "pa_1", "sg_4", "sg_5", "sg_5", "sg_5", "sg_6", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "pa_1", "gr_0", "gr_0", "fw_0", "tr_0", "tr_0", "pa_1", "sg_3", "be_4", "be_5", "be_6", "sg_7", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "be_7", "sg_7", "gr_0", "xx_0", "gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "pa_1", "ho_0", "sg_3", "be_3", "be_7", "sg_7", "tr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "fe_1", "gr_0", "gr_0", "sg_3", "be_3", "be_7", "sg_7", "tr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "sg_5", "sg_5", "gr_0", "gr_0", "gr_0", "fe_1", "gr_0", "sg_3", "be_3", "oc_0", "be_7", "sg_7", "gr_0", "gr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "be_5", "be_5", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "oc_0", "gr_0", "gr_0", "gr_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"]];

// Small islands
var appearanceMap_2_1 = [["tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "tr_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "gr_0", "bg_0", "pa_1", "ho_0", "gr_0", "gr_0", "gr_0", "tr_0", "tr_0"],
                         ["tr_0", "tr_0", "tr_0", "ho_0", "tr_0", "tr_0", "pa_1", "ho_0", "tr_0", "bg_0", "ho_0", "bg_0", "tr_0", "pa_1", "ho_0", "bg_0", "tr_0", "ho_0", "tr_0", "tr_0"],
                         ["pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "px_1", "pa_2", "pa_2", "pa_2", "px_3", "pa_2", "pa_2", "px_1", "pa_2", "pa_2", "pa_2", "pa_2", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "tr_0", "tr_0", "gr_0", "gr_0", "bg_0", "ho_0", "bg_0", "ho_0", "pa_1", "ho_0", "bg_0", "ho_0", "bg_0", "ho_0", "tr_0", "tr_0", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "bg_0", "ho_0", "pa_1", "bg_0", "bg_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "tr_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "tr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0"],
                         ["pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_2", "pa_3", "gr_0", "oc_0", "oc_0", "oc_0", "gr_0", "gr_0", "oc_0", "oc_0", "tr_0", "gr_0", "oc_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "pa_1", "gr_0", "oc_0", "oc_0", "tr_0", "gr_0", "tr_0", "oc_0", "oc_0", "oc_0", "gr_0", "oc_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "tr_0", "tr_0", "fw_0", "gr_0", "pa_1", "gr_0", "bo_2", "bo_2", "gr_0", "gr_0", "gr_0", "bo_2", "bo_2", "bo_2", "gr_0", "gr_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "tr_0", "tr_0", "fw_0", "gr_0", "pa_1", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "gr_0", "oc_0", "oc_0", "oc_0", "gr_0", "tr_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "gr_0", "tr_0", "tr_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "bo_1", "oc_0", "oc_0", "oc_0", "oc_0", "tr_0", "oc_0", "oc_0"],
                         ["gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "be_1", "bo_1", "be_1", "be_1", "be_1", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "gr_0", "oc_0", "oc_0", "oc_0", "oc_0", "sa_0", "sa_0", "sa_0", "sa_0", "sa_0", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "be_5", "be_5", "be_5", "be_5", "be_5", "oc_0", "oc_0", "oc_0", "oc_0"],
                         ["oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0", "oc_0"]];

/*
############################
###   Interaction maps   ###
############################
*/

// Seaside forest
var interactionMap_0_0 = [[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 12, 12, 12,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 12,  0, 12,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 11,  0,  0, 12, 12, 12,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 14, 14,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 14, 14,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0, 13, 13,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 13,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]];

// River
var interactionMap_0_1 = [[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 22, 22, 22,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0, 21,  0,  0,  0,  0,  0,  0, 22,  0, 22,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 22, 22, 22,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 23,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 23,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0, 27, 27, 27,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 26,  0, 27,  0, 27,  0,  0,  0,  0,  0, 28,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0, 27,  0, 27,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0, 27, 27, 27,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]];

// Home
var interactionMap_1_0 = [[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0, 31,  0,  0,  0,  0,  0, 32, 32,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0, 31, 31,  0,  0,  0,  0,  0, 32, 32,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0, 32, 32,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 33,  0,  0,  0, 37, 37,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0, 34,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0, 34, 34,  0,  0,  0,  0,  0,  0, 36,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0, 34,  0,  0,  0,  0, 35,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 35,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 35,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 35,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 38,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 38,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 38,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]];

// Town
var interactionMap_1_1 = [[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 41,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43, 43,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 42,  0,  0,  0,  0, 43,  0,  0,  0,  0,  0, 44,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0, 45,  0,  0,  0,  0,  0,  0,  0,  0,  0, 46, 46, 46,  0,  0, 47, 47,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 46, 46, 46,  0,  0,  0, 47,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 46, 46, 46,  0,  0, 47, 47,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43,  0, 43,  0,  0],
                          [ 0,  0,  0,  0,  0, 48,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43, 43, 43,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 49,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]];

// Main island
var interactionMap_2_0 = [[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0, 51,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 53,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 55,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 52,  0,  0,  0,  0,  0,  0,  0, 54,  0,  0, 55,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 54, 54,  0,  0, 55,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 55,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]];

// Small islands
var interactionMap_2_1 = [[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 61,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 61,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 66, 66,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 66, 66,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 64, 64,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0, 62, 62,  0,  0,  0,  0,  0, 64,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0, 62,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0, 62,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0, 63,  0,  0,  0,  0,  0,  0, 65, 65, 65, 65, 65,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                          [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]];

/*
###########################################
###   Introduction and initialization   ###
###########################################
*/

function intro(){
    // Game state
    gameState = "intro";

    // Background canvas
    var canvasBG = document.getElementById("canvasBG");
    canvasBG.width = STAGE_DIM;
    canvasBG.height = STAGE_DIM;
    bg = canvasBG.getContext('2d');

    // Foreground canvas
    var canvasFG = document.getElementById("canvasFG");
    canvasFG.width = STAGE_DIM;
    canvasFG.height = STAGE_DIM;
    fg = canvasFG.getContext('2d');

    // Cloud shadow canvas
    var canvasSG = document.getElementById("canvasSG");
    canvasSG.width = STAGE_DIM;
    canvasSG.height = STAGE_DIM;
    sg = canvasSG.getContext('2d');

    // Cloud canvas
    var canvasCG = document.getElementById("canvasCG");
    canvasCG.width = STAGE_DIM;
    canvasCG.height = STAGE_DIM;
    cg = canvasCG.getContext('2d');

    // Message canvas
    var canvasMG = document.getElementById("canvasMG");
    canvasMG.width = STAGE_DIM;
    canvasMG.height = STAGE_DIM;
    mg = canvasMG.getContext('2d');

    // Images
    imgClouds          = new Image();
    imgClouds.src      = "media/clouds.png";
    imgCloudShadow     = new Image();
    imgCloudShadow.src = "media/cloud_shadow.png";
    imgGrass           = new Image();
    imgGrass.src       = "media/grass.png";
    imgIntro           = new Image();
    imgIntro.src       = "media/intro.png";
    imgIntro.onload    = function(){bg.drawImage(imgIntro, 0, 0, STAGE_DIM, STAGE_DIM, 0, 0, STAGE_DIM, STAGE_DIM);}
    imgMessages        = new Image();
    imgMessages.src    = "media/messages.png";
    imgMonument        = new Image();
    imgMonument.src    = "media/monument.png";
    imgShip            = new Image();
    imgShip.src        = "media/ship.png";
    imgX               = new Image();
    imgX.src           = "media/x.png";

    // Audio
    var audioMusic  = document.getElementById("audioMusic");
    var audioShovel = document.getElementById("audioShovel");
    var audioWin    = document.getElementById("audioWin");

    // Event listeners
    window.addEventListener("keydown", onKeyDown);
    window.addEventListener("keyup", onKeyUp);
}

/*
###########################
###   Event listeners   ###
###########################
*/

// On key down event listener
function onKeyDown(e){
    if (gameState == "walk"){
        switch (e.keyCode){
            case 37: // Left arrow
                player.isMovingLeft = true;
                break;
            case 39: // Right arrow
                player.isMovingRight = true;
                break;
            case 38: // Up arrow
                player.isMovingUp = true;
                break;
            case 40: // Down arrow
                player.isMovingDown = true;
                break;
        }
    }
}

// On key up event listener
function onKeyUp(e){
    if (gameState == "intro"){
        switch (e.keyCode){
            case 32: // Space bar
                // Clear background canvas
                bg.clearRect(0, 0, STAGE_DIM, STAGE_DIM);

                // Create new world
                world = new World(1, 0);

                // Initialize tiles, player, clouds, and message
                initTiles();
                drawTiles();
                player = new Player(10, 10);
                player.draw();
                initClouds();
                drawClouds();
                message = new Message();

                // Set game state and looping interval
                gameState = "walk";
                loopInterval = setInterval(loop, 1000/FPS);

                // Play audio
                audioMusic.play();
                break;
        }
    } else if (gameState == "walk"){
        switch (e.keyCode){
            case 32: // Space bar
                if (player.canInteract){
                    player.isMovingLeft  = false;
                    player.isMovingRight = false;
                    player.isMovingUp    = false;
                    player.isMovingDown  = false;
                    gameState            = "message";
                    message.draw();
                }
                if (player.onTreasure){
                    audioWin.currentTime = 0;
                    audioWin.play();
                } else if (! player.canInteract) {
                    audioShovel.currentTime = 0;
                    audioShovel.play();
                }
                break;
            case 37: // Left arrow
                player.isMovingLeft = false;
                break;
            case 39: // Right arrow
                player.isMovingRight = false;
                break;
            case 38: // Up arrow
                player.isMovingUp = false;
                break;
            case 40: // Down arrow
                player.isMovingDown = false;
                break;
        }
    } else if (gameState == "message"){
        switch (e.keyCode){
            case 32: // Space bar
                if (player.canInteract){
                    message.clear();
                    gameState = "walk";
                }
                break;
        }
    }
}

/*
################
###   Loop   ###
################
*/

function loop(){
    // World
    if (gameState == "walk"){
        world.update();
    }

    // Tiles
    clearTiles();
    updateTiles();
    drawTiles();

    // Player
    if (gameState == "walk"){
        player.clear();
    }
    player.update();
    if (gameState == "walk"){
        player.draw();
    }

    // Clouds
    clearClouds();
    updateClouds();
    drawClouds();
}

/*
#################
###   World   ###
#################
*/

function World(iStart, jStart){
    // Initialize world
    this.init = function(){
        this.appearanceMaps = [];
        this.interactionMaps = [];
        for (var i=0; i<WORLD_HEIGHT; i++){
            this.appearanceMaps.push([]);
            this.interactionMaps.push([]);
            for (var j=0; j<WORLD_WIDTH; j++){
                eval("this.appearanceMaps[" + i + "].push(appearanceMap_" + i + "_" + j + ");");
                eval("this.interactionMaps[" + i + "].push(interactionMap_" + i + "_" + j + ");");
            }
        }
        this.iWorld = iStart;
        this.jWorld = jStart;
        this.appearanceMap = this.appearanceMaps[this.iWorld][this.jWorld];
        this.interactionMap = this.interactionMaps[this.iWorld][this.jWorld];
    }

    // Update world
    this.update = function(){
        if (player.x <= -player.width/2){
            this.jWorld -= 1;
            player.x = STAGE_DIM - player.width;
            this.appearanceMap = this.appearanceMaps[this.iWorld][this.jWorld];
            this.interactionMap = this.interactionMaps[this.iWorld][this.jWorld];
            initTiles();
            initClouds();
        } else if (player.x >= STAGE_DIM - player.width/2){
            this.jWorld += 1;
            player.x = 0;
            this.appearanceMap = this.appearanceMaps[this.iWorld][this.jWorld];
            this.interactionMap = this.interactionMaps[this.iWorld][this.jWorld];
            initTiles();
            initClouds();
        } else if (player.y <= -player.height/2){
            this.iWorld -= 1;
            player.y = STAGE_DIM - player.height;
            this.appearanceMap = this.appearanceMaps[this.iWorld][this.jWorld];
            this.interactionMap = this.interactionMaps[this.iWorld][this.jWorld];
            initTiles();
            initClouds();
        } else if (player.y >= STAGE_DIM - player.height/2){
            this.iWorld += 1;
            player.y = 0;
            this.appearanceMap = this.appearanceMaps[this.iWorld][this.jWorld];
            this.interactionMap = this.interactionMaps[this.iWorld][this.jWorld];
            initTiles();
            initClouds();
        }
    }

    this.init();
}

/*
#################
###   Tiles   ###
#################
*/

function Tile(codeAppearance, codeInteraction, i, j){
    // Initialize tile
    this.init = function(){
        var codeAppearanceList = codeAppearance.split("_");
        this.type              = codeAppearanceList[0];
        this.dir               = codeAppearanceList[1];
        this.codeInteraction   = codeInteraction;
        this.x                 = j*TILE_DIM;
        this.y                 = i*TILE_DIM;

        // Random numbers for tiles that use them
        this.rng1 = Math.random();
        this.rng2 = Math.random();

        // Default color ranges
        this.r0 = 255;
        this.r1 = 255;
        this.g0 = 255;
        this.g1 = 255;
        this.b0 = 255;
        this.b1 = 255;

        // Walk-over effect parameters
        this.walkOverStart  = false;
        this.walkOverEffect = false;
        this.walkOverAlpha  = 0;

        // Tile properties and color ranges
        switch (this.type){
            case "be": // Beach
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 100;
                this.r1 = 250;
                this.g0 = 220;
                this.g1 = 220;
                this.b0 = 220;
                this.b1 = 250;
                break;
            case "bf": // Bridge over fresh water
                this.isWalkable = true;
                this.redraw = true;
                this.r0 = 0;
                this.r1 = 70;
                this.g0 = 100;
                this.g1 = 140;
                this.b0 = 200;
                this.b1 = 200;
                break;
            case "bg": // Building
                this.isWalkable = false;
                this.redraw = false;
                this.r0 = 200;
                this.r1 = 255;
                this.g0 = 200;
                this.g1 = 255;
                this.b0 = 200;
                this.b1 = 200;
                break;
           case "bo": // Bridge over ocean
                this.isWalkable = true;
                this.redraw = true;
                this.r0 = 100;
                this.r1 = 250;
                this.g0 = 220;
                this.g1 = 220;
                this.b0 = 220;
                this.b1 = 250;
                break;
           case "e1": // Estuary one
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 70;
                this.r1 = 80;
                this.g0 = 140;
                this.g1 = 165;
                this.b0 = 200;
                this.b1 = 205;
                break;
           case "e2": // Estuary two
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 80;
                this.r1 = 90;
                this.g0 = 165;
                this.g1 = 195;
                this.b0 = 205;
                this.b1 = 215;
                break;
           case "e3": // Estuary three
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 90;
                this.r1 = 100;
                this.g0 = 195;
                this.g1 = 220;
                this.b0 = 215;
                this.b1 = 220;
                break;
           case "fe": // Fence
                this.isWalkable = false;
                this.redraw = false;
                break;
            case "fi": // Field
                this.isWalkable = true;
                this.redraw = false;
                break;
            case "fw": // Fresh water
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 0;
                this.r1 = 70;
                this.g0 = 100;
                this.g1 = 140;
                this.b0 = 200;
                this.b1 = 200;
                break;
            case "gr": // Grass
                this.isWalkable = true;
                this.redraw = false;
                break;
            case "hb": // Brian's house
                this.isWalkable = false;
                this.redraw = false;
                break;
            case "ho": // House
                this.isWalkable = false;
                this.redraw = false;
                this.r0 = 215;
                this.r1 = 255;
                this.g0 = 215;
                this.g1 = 255;
                this.b0 = 215;
                this.b1 = 200;
                break;
           case "lh": // Lighthouse
                this.isWalkable = false;
                this.redraw = true;
                break;
            case "mo": // Monument
                this.isWalkable = false;
                this.redraw = false;
                break;
            case "oc": // Ocean
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 100;
                this.r1 = 250;
                this.g0 = 220;
                this.g1 = 220;
                this.b0 = 220;
                this.b1 = 250;
                break;
            case "pa": // Path
                this.isWalkable = true;
                this.redraw = false;
                break;
            case "px": // Path intersection
                this.isWalkable = true;
                this.redraw = false;
                break;
            case "sa": // Sand
                this.isWalkable = true;
                this.redraw = false;
                break;
            case "sf": // Ship over fresh water
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 0;
                this.r1 = 70;
                this.g0 = 100;
                this.g1 = 140;
                this.b0 = 200;
                this.b1 = 200;
                break;
           case "sg": // Sandy grass
                this.isWalkable = true;
                this.redraw = false;
                break;
            case "so": // Ship over ocean
                this.isWalkable = false;
                this.redraw = true;
                this.r0 = 100;
                this.r1 = 250;
                this.g0 = 220;
                this.g1 = 220;
                this.b0 = 220;
                this.b1 = 250;
                break;
           case "tr": // Tree
                this.isWalkable = false;
                this.redraw = false;
                this.r0 = 0;
                this.r1 = 0;
                this.g0 = 60;
                this.g1 = 150;
                this.b0 = 0;
                this.b1 = 0;
                break;
            case "xx": // X marks the spot
                this.isWalkable = true;
                this.redraw = false;
                break;
        }
        this.r  = this.getRandomColorValue(this.r0, this.r1);
        this.rt = this.getRandomColorValue(this.r0, this.r1);
        this.g  = this.getRandomColorValue(this.g0, this.g1);
        this.gt = this.getRandomColorValue(this.g0, this.g1);
        this.b  = this.getRandomColorValue(this.b0, this.b1);
        this.bt = this.getRandomColorValue(this.b0, this.b1);
    }

    // Draw tile
    this.draw = function(){
        // Draw tile according to type
        switch (this.type){
            case "be": // Beach
                switch (this.dir){
                        case "7":
                            var grd = bg.createLinearGradient(this.x + TILE_DIM, this.y, this.x, this.y);
                            break;
                        case "3":
                            var grd = bg.createLinearGradient(this.x, this.y, this.x + TILE_DIM, this.y);
                            break;
                        case "1":
                            var grd = bg.createLinearGradient(this.x, this.y + TILE_DIM, this.x, this.y);
                            break;
                        case "5":
                            var grd = bg.createLinearGradient(this.x, this.y, this.x, this.y + TILE_DIM);
                            break;
                        case "8":
                            var grd = bg.createLinearGradient(this.x + 2*TILE_DIM/3, this.y + 2*TILE_DIM/3, this.x, this.y);
                            break;
                        case "4":
                            var grd = bg.createLinearGradient(this.x + TILE_DIM/3, this.y + TILE_DIM/3, this.x + TILE_DIM, this.y + TILE_DIM);
                            break;
                        case "2":
                            var grd = bg.createLinearGradient(this.x + TILE_DIM/3, this.y + 2*TILE_DIM/3, this.x + TILE_DIM, this.y);
                            break;
                        case "6":
                            var grd = bg.createLinearGradient(this.x + 2*TILE_DIM/3, this.y + TILE_DIM/3, this.x, this.y + TILE_DIM);
                            break;
                }
                grd.addColorStop(0, COL_SAND);
                grd.addColorStop(1, this.getRGB());
                bg.fillStyle = grd;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "bf": // Bridge over fresh water
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                bg.globalAlpha = 0.25;
                bg.fillStyle = COL_WHITE;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                bg.globalAlpha = 1;
                switch (this.dir){
                    case "1":
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x + TILE_DIM/3, this.y);
                        bg.lineTo(this.x + TILE_DIM/3, this.y + TILE_DIM);
                        bg.stroke();
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x + 2*TILE_DIM/3, this.y);
                        bg.lineTo(this.x + 2*TILE_DIM/3, this.y + TILE_DIM);
                        bg.stroke();
                        bg.beginPath();
                        bg.fillStyle = COL_BROWN_DARK;
                        bg.fillRect(this.x + TILE_DIM/6, this.y, 4*TILE_DIM/6, TILE_DIM/6);
                        bg.fillRect(this.x + TILE_DIM/6, this.y + 2*TILE_DIM/6, 4*TILE_DIM/6, 2*TILE_DIM/6);
                        bg.fillRect(this.x + TILE_DIM/6, this.y + 5*TILE_DIM/6, 4*TILE_DIM/6, TILE_DIM/6);
                        break;
                    case "2":
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x, this.y + TILE_DIM/3);
                        bg.lineTo(this.x + TILE_DIM, this.y + TILE_DIM/3);
                        bg.stroke();
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x, this.y + 2*TILE_DIM/3);
                        bg.lineTo(this.x + TILE_DIM, this.y + 2*TILE_DIM/3);
                        bg.stroke();
                        bg.beginPath();
                        bg.fillStyle = COL_BROWN_DARK;
                        bg.fillRect(this.x, this.y + TILE_DIM/6, TILE_DIM/6, 4*TILE_DIM/6);
                        bg.fillRect(this.x + 2*TILE_DIM/6, this.y + TILE_DIM/6, 2*TILE_DIM/6, 4*TILE_DIM/6);
                        bg.fillRect(this.x + 5*TILE_DIM/6, this.y + TILE_DIM/6, TILE_DIM/6, 4*TILE_DIM/6);
                        break;
                }
                break;
            case "bg": // Building
                // Tile
                var grd = bg.createRadialGradient(this.x + TILE_DIM/2, this.y + TILE_DIM, 0, this.x + TILE_DIM/2, this.y + TILE_DIM, TILE_DIM);
                grd.addColorStop(0, COL_GRASS_DARK);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);

                // House
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x + TILE_DIM/7, this.y, 5*TILE_DIM/7, 6*TILE_DIM/7);
                if (this.rng1 < 0.5){
                    // Lower window
                    bg.fillStyle = COL_BLACK;
                    bg.fillRect(this.x + 2*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);

                    // Door
                    bg.fillStyle = COL_BLACK;
                    bg.fillRect(this.x + 4*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, 3*TILE_DIM/7);

                } else {
                    // Lower window
                    bg.fillStyle = COL_BLACK;
                    bg.fillRect(this.x + 4*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);

                    // Door
                    bg.fillStyle = COL_BLACK;
                    bg.fillRect(this.x + 2*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, 3*TILE_DIM/7);
                }

                // Upper windows
                bg.fillStyle = COL_BLACK;
                bg.fillRect(this.x + 2*TILE_DIM/7, this.y + TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);
                bg.fillRect(this.x + 4*TILE_DIM/7, this.y + TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);
                break;
            case "bo": // Bridge over ocean
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                switch (this.dir){
                    case "1":
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x + TILE_DIM/3, this.y);
                        bg.lineTo(this.x + TILE_DIM/3, this.y + TILE_DIM);
                        bg.stroke();
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x + 2*TILE_DIM/3, this.y);
                        bg.lineTo(this.x + 2*TILE_DIM/3, this.y + TILE_DIM);
                        bg.stroke();
                        bg.beginPath();
                        bg.fillStyle = COL_BROWN_DARK;
                        bg.fillRect(this.x + TILE_DIM/6, this.y, 4*TILE_DIM/6, TILE_DIM/6);
                        bg.fillRect(this.x + TILE_DIM/6, this.y + 2*TILE_DIM/6, 4*TILE_DIM/6, 2*TILE_DIM/6);
                        bg.fillRect(this.x + TILE_DIM/6, this.y + 5*TILE_DIM/6, 4*TILE_DIM/6, TILE_DIM/6);
                        break;
                    case "2":
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x, this.y + TILE_DIM/3);
                        bg.lineTo(this.x + TILE_DIM, this.y + TILE_DIM/3);
                        bg.stroke();
                        bg.strokeStyle = COL_BROWN_DARK;
                        bg.beginPath();
                        bg.moveTo(this.x, this.y + 2*TILE_DIM/3);
                        bg.lineTo(this.x + TILE_DIM, this.y + 2*TILE_DIM/3);
                        bg.stroke();
                        bg.beginPath();
                        bg.fillStyle = COL_BROWN_DARK;
                        bg.fillRect(this.x, this.y + TILE_DIM/6, TILE_DIM/6, 4*TILE_DIM/6);
                        bg.fillRect(this.x + 2*TILE_DIM/6, this.y + TILE_DIM/6, 2*TILE_DIM/6, 4*TILE_DIM/6);
                        bg.fillRect(this.x + 5*TILE_DIM/6, this.y + TILE_DIM/6, TILE_DIM/6, 4*TILE_DIM/6);
                        break;
                }
                break;
            case "fe": // Fence
                if (this.rng1 < 0.5){
                    bg.fillStyle = COL_GRASS;
                    bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                } else if (this.rng1 < 0.625){
                    bg.drawImage(imgGrass, 0, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                } else if (this.rng1 < 0.75){
                    bg.drawImage(imgGrass, 30, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                } else if (this.rng1 < 0.875){
                    bg.drawImage(imgGrass, 60, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                } else {
                    bg.drawImage(imgGrass, 90, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                }
                bg.fillStyle = COL_BROWN_FENCE;
                switch (this.dir){
                    case "1":
                        bg.fillRect(this.x + TILE_DIM/2, this.y, TILE_DIM/8, 3*TILE_DIM/8);
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + TILE_DIM/8, TILE_DIM/8, 6*TILE_DIM/8);
                        bg.fillRect(this.x + TILE_DIM/2, this.y + 5*TILE_DIM/8, TILE_DIM/8, 3*TILE_DIM/8);
                        break;
                    case "2":
                        bg.fillRect(this.x, this.y + TILE_DIM/2, 3*TILE_DIM/8, TILE_DIM/8);
                        bg.fillRect(this.x + TILE_DIM/8, this.y + 3*TILE_DIM/8, 6*TILE_DIM/8, TILE_DIM/8);
                        bg.fillRect(this.x + 5*TILE_DIM/8, this.y + TILE_DIM/2, 3*TILE_DIM/8, TILE_DIM/8);
                        break;
                    case "3":
                        bg.fillRect(this.x + TILE_DIM/8, this.y + 3*TILE_DIM/8, 4*TILE_DIM/8, 2*TILE_DIM/8);
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + 3*TILE_DIM/8, 2*TILE_DIM/8, 4*TILE_DIM/8);
                        bg.fillRect(this.x, this.y + 4*TILE_DIM/8, 4*TILE_DIM/8, TILE_DIM/8);
                        bg.fillRect(this.x + 4*TILE_DIM/8, this.y + 4*TILE_DIM/8, TILE_DIM/8, 4*TILE_DIM/8);
                        break;
                    case "4":
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + TILE_DIM/8, 2*TILE_DIM/8, 4*TILE_DIM/8);
                        bg.fillRect(this.x + TILE_DIM/8, this.y + 3*TILE_DIM/8, 4*TILE_DIM/8, 2*TILE_DIM/8);
                        bg.fillRect(this.x + 4*TILE_DIM/8, this.y, TILE_DIM/8, 4*TILE_DIM/8);
                        bg.fillRect(this.x, this.y + 4*TILE_DIM/8, 4*TILE_DIM/8, TILE_DIM/8);
                        break;
                    case "5":
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + TILE_DIM/8, 2*TILE_DIM/8, 4*TILE_DIM/8);
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + 3*TILE_DIM/8, 4*TILE_DIM/8, 2*TILE_DIM/8);
                        bg.fillRect(this.x + 4*TILE_DIM/8, this.y, TILE_DIM/8, 4*TILE_DIM/8);
                        bg.fillRect(this.x + 4*TILE_DIM/8, this.y + 4*TILE_DIM/8, 4*TILE_DIM/8, TILE_DIM/8);
                        break;
                    case "6":
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + 3*TILE_DIM/8, 4*TILE_DIM/8, 2*TILE_DIM/8);
                        bg.fillRect(this.x + 3*TILE_DIM/8, this.y + 3*TILE_DIM/8, 2*TILE_DIM/8, 4*TILE_DIM/8);
                        bg.fillRect(this.x + 4*TILE_DIM/8, this.y + 4*TILE_DIM/8, 4*TILE_DIM/8, TILE_DIM/8);
                        bg.fillRect(this.x + 4*TILE_DIM/8, this.y + 4*TILE_DIM/8, TILE_DIM/8, 4*TILE_DIM/8);
                        break;
                }
                break;
            case "fi": // Field
                var count = 0;
                for (var i=0; i<5; i++){
                    for (var j=0; j<5; j++){
                        count++;
                        var val = parseInt(Math.pow(10, count) * this.rng1) % 5;
                        switch (val){
                            case 0:
                                bg.fillStyle = COL_BROWN_DARK;
                                break;
                            case 1:
                                bg.fillStyle = COL_GRASS_DARK;
                                break;
                            case 2:
                                bg.fillStyle = COL_ORANGE;
                                break;
                            case 3:
                                bg.fillStyle = COL_TREE;
                                break;
                            case 4:
                                bg.fillStyle = COL_YELLOW;
                                break;
                        }
                        bg.fillRect(this.x + i*TILE_DIM/5, this.y + j*TILE_DIM/5, TILE_DIM/5, TILE_DIM/5);
                    }
                }
                break;
            case "fw": // Fresh water
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "e1": // Estuary one
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "e2": // Estuary two
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "e3": // Estuary three
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "gr": // Grass
                if (this.rng1 < 0.5){
                    bg.fillStyle = COL_GRASS;
                    bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                } else if (this.rng1 < 0.625){
                    bg.drawImage(imgGrass, 0, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                } else if (this.rng1 < 0.75){
                    bg.drawImage(imgGrass, 30, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                } else if (this.rng1 < 0.875){
                    bg.drawImage(imgGrass, 60, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                } else {
                    bg.drawImage(imgGrass, 90, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                }
                break;
            case "hb": // Brian's house
                // Tile
                var grd = bg.createRadialGradient(this.x + TILE_DIM/2, this.y + TILE_DIM, 0, this.x + TILE_DIM/2, this.y + TILE_DIM, TILE_DIM);
                grd.addColorStop(0, COL_GRASS_DARK);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);

                // House
                bg.fillStyle = COL_WHITE;
                bg.fillRect(this.x + TILE_DIM/7, this.y + 2*TILE_DIM/7, 5*TILE_DIM/7, 4*TILE_DIM/7);

                // Window
                bg.fillStyle = COL_BLACK;
                bg.fillRect(this.x + 2*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);

                // Door
                bg.fillStyle = COL_BLACK;
                bg.fillRect(this.x + 4*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, 3*TILE_DIM/7);

                // Roof
                bg.fillStyle = COL_BLACK;
                bg.beginPath()
                bg.moveTo(this.x + TILE_DIM/2, this.y);
                bg.lineTo(this.x + TILE_DIM, this.y + 2*TILE_DIM/7);
                bg.lineTo(this.x, this.y + 2*TILE_DIM/7);
                bg.fill();
                break;
            case "ho": // House
                // Tile
                var grd = bg.createRadialGradient(this.x + TILE_DIM/2, this.y + TILE_DIM, 0, this.x + TILE_DIM/2, this.y + TILE_DIM, TILE_DIM);
                grd.addColorStop(0, COL_GRASS_DARK);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);

                // House
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x + TILE_DIM/7, this.y + 2*TILE_DIM/7, 5*TILE_DIM/7, 4*TILE_DIM/7);
                if (this.rng1 < 0.5){
                    // Window
                    bg.fillStyle = COL_BLACK;
                    bg.fillRect(this.x + 2*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);

                    // Door
                    if (this.rng2 < 0.5){
                        bg.fillStyle = COL_RED_ROOF;
                    } else {
                        bg.fillStyle = COL_BLACK;
                    }
                    bg.fillRect(this.x + 4*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, 3*TILE_DIM/7);
                } else {
                    // Window
                    bg.fillStyle = COL_BLACK;
                    bg.fillRect(this.x + 4*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, TILE_DIM/7);

                    // Door
                    if (this.rng2 < 0.5){
                        bg.fillStyle = COL_RED_ROOF;
                    } else {
                        bg.fillStyle = COL_BLACK;
                    }
                    bg.fillRect(this.x + 2*TILE_DIM/7, this.y + 3*TILE_DIM/7, TILE_DIM/7, 3*TILE_DIM/7);
                }

                // Roof
                if (this.rng2 < 0.5){
                    bg.fillStyle = COL_BLACK;
                } else {
                    bg.fillStyle = COL_RED_ROOF;
                }
                bg.beginPath()
                bg.moveTo(this.x + TILE_DIM/2, this.y);
                bg.lineTo(this.x + TILE_DIM, this.y + 2*TILE_DIM/7);
                bg.lineTo(this.x, this.y + 2*TILE_DIM/7);
                bg.fill();
                break;
            case "lh": // Lighthouse
                // Tile
                var grd = bg.createRadialGradient(this.x + TILE_DIM/2, this.y + TILE_DIM, 0, this.x + TILE_DIM/2, this.y + TILE_DIM, TILE_DIM);
                grd.addColorStop(0, COL_GRASS_DARK);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);

                // Lighthouse
                bg.fillStyle = COL_WHITE;
                bg.beginPath()
                bg.moveTo(this.x + TILE_DIM/8, this.y + 7*TILE_DIM/8);
                bg.lineTo(this.x + TILE_DIM/4, this.y - TILE_DIM/8);
                bg.lineTo(this.x + 3*TILE_DIM/4, this.y - TILE_DIM/8);
                bg.lineTo(this.x + 7*TILE_DIM/8, this.y + 7*TILE_DIM/8);
                bg.fill();

                // Red top with light
                bg.fillStyle = COL_RED;
                bg.fillRect(this.x + TILE_DIM/4, this.y - 5*TILE_DIM/8, TILE_DIM/2, TILE_DIM/2);

                // White top
                bg.fillStyle = COL_WHITE;
                bg.fillRect(this.x + TILE_DIM/4, this.y - 6*TILE_DIM/8, TILE_DIM/2, TILE_DIM/8);

                // Red top
                bg.fillStyle = COL_RED;
                bg.fillRect(this.x + TILE_DIM/4, this.y - 7*TILE_DIM/8, TILE_DIM/2, TILE_DIM/8);

                // Door
                bg.fillStyle = COL_BLACK;
                bg.fillRect(this.x + 3*TILE_DIM/8, this.y + 3*TILE_DIM/8, TILE_DIM/4, TILE_DIM/2);

                // Light
                bg.fillStyle = COL_WHITE;
                bg.beginPath();
                bg.arc(this.x + TILE_DIM/2, this.y - 3*TILE_DIM/8, TILE_DIM/8, 0, 2*Math.PI);
                bg.fill();

                // Circular rim around light
                bg.fillStyle = COL_BLACK;
                bg.beginPath();
                bg.arc(this.x + TILE_DIM/2, this.y - 3*TILE_DIM/8, TILE_DIM/8, 0, 2*Math.PI);
                bg.stroke();
                break;
            case "mo": // Monument
                // Tile
                var grd = bg.createRadialGradient(this.x + TILE_DIM/2, this.y + TILE_DIM, 0, this.x + TILE_DIM/2, this.y + TILE_DIM, TILE_DIM);
                grd.addColorStop(0, COL_GRASS_DARK);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);

                // Monument
                bg.drawImage(imgMonument, 0, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "oc": // Ocean
                bg.fillStyle = this.getRGB();
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "pa": // Path
                bg.fillStyle = COL_GRASS;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                bg.fillStyle = COL_PATH;
                switch (this.dir){
                    case "1":
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, TILE_DIM);
                        break;
                    case "2":
                        bg.fillRect(this.x, this.y + TILE_DIM/4, TILE_DIM, TILE_DIM/2);
                        break;
                    case "3":
                        bg.fillRect(this.x, this.y + TILE_DIM/4, 3*TILE_DIM/4, TILE_DIM/2);
                        bg.fillRect(this.x + TILE_DIM/4, this.y + TILE_DIM/4, TILE_DIM/2, 3*TILE_DIM/4);
                        break;
                    case "4":
                        bg.fillRect(this.x, this.y + TILE_DIM/4, 3*TILE_DIM/4, TILE_DIM/2);
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, 3*TILE_DIM/4);
                        break;
                    case "5":
                        bg.fillRect(this.x + TILE_DIM/4, this.y + TILE_DIM/4, 3*TILE_DIM/4, TILE_DIM/2);
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, 3*TILE_DIM/4);
                        break;
                    case "6":
                        bg.fillRect(this.x + TILE_DIM/4, this.y + TILE_DIM/4, 3*TILE_DIM/4, TILE_DIM/2);
                        bg.fillRect(this.x + TILE_DIM/4, this.y + TILE_DIM/4, TILE_DIM/2, 3*TILE_DIM/4);
                        break;
                }
                break;
            case "px": // Path intersection
                bg.fillStyle = COL_GRASS;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                bg.fillStyle = COL_PATH;
                switch (this.dir){
                    case "1":
                        bg.fillRect(this.x, this.y + TILE_DIM/4, TILE_DIM, TILE_DIM/2);
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, 3*TILE_DIM/4);
                        break;
                    case "2":
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, TILE_DIM);
                        bg.fillRect(this.x + TILE_DIM/4, this.y + TILE_DIM/4, 3*TILE_DIM/4, TILE_DIM/2);
                        break;
                    case "3":
                        bg.fillRect(this.x, this.y + TILE_DIM/4, TILE_DIM, TILE_DIM/2);
                        bg.fillRect(this.x + TILE_DIM/4, this.y + TILE_DIM/4, TILE_DIM/2, 3*TILE_DIM/4);
                        break;
                    case "4":
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, TILE_DIM);
                        bg.fillRect(this.x, this.y + TILE_DIM/4, 3*TILE_DIM/4, TILE_DIM/2);
                        break;
                    case "5":
                        bg.fillRect(this.x + TILE_DIM/4, this.y, TILE_DIM/2, TILE_DIM);
                        bg.fillRect(this.x, this.y + TILE_DIM/4, TILE_DIM, TILE_DIM/2);
                        break;
                }
                break;
            case "sa": // Sand
                bg.fillStyle = COL_SAND;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "sf": // Ship over fresh water
                if (this.dir == "1"){
                    bg.fillStyle = this.getRGB();
                    bg.fillRect(this.x, this.y, 2*TILE_DIM, TILE_DIM);
                    bg.drawImage(imgShip, 60, 0, 2*TILE_DIM, TILE_DIM, this.x, this.y, 2*TILE_DIM, TILE_DIM);
                }
                break;
            case "sg": // Sandy grass
                switch (this.dir){
                    case "7":
                        var grd = bg.createLinearGradient(this.x, this.y, this.x + TILE_DIM, this.y);
                        break;
                    case "3":
                        var grd = bg.createLinearGradient(this.x + TILE_DIM, this.y, this.x, this.y);
                        break;
                    case "1":
                        var grd = bg.createLinearGradient(this.x, this.y, this.x, this.y + TILE_DIM);
                        break;
                    case "5":
                        var grd = bg.createLinearGradient(this.x, this.y + TILE_DIM, this.x, this.y);
                        break;
                    case "8":
                        var grd = bg.createLinearGradient(this.x, this.y, this.x + TILE_DIM/2, this.y + TILE_DIM/2);
                        break;
                    case "4":
                        var grd = bg.createLinearGradient(this.x + TILE_DIM, this.y + TILE_DIM, this.x + TILE_DIM/2, this.y + TILE_DIM/2);
                        break;
                    case "2":
                        var grd = bg.createLinearGradient(this.x + TILE_DIM, this.y, this.x + TILE_DIM/2, this.y + TILE_DIM/2);
                        break;
                    case "6":
                        var grd = bg.createLinearGradient(this.x, this.y + TILE_DIM, this.x + TILE_DIM/2, this.y + TILE_DIM/2);
                        break;
                }
                grd.addColorStop(0, COL_SAND);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                break;
            case "so": // Ship over ocean
                if (this.dir == "1"){
                    bg.fillStyle = this.getRGB();
                    bg.fillRect(this.x, this.y, 2*TILE_DIM, TILE_DIM);
                    bg.drawImage(imgShip, 0, 0, 2*TILE_DIM, TILE_DIM, this.x, this.y, 2*TILE_DIM, TILE_DIM);
                }
                break;
            case "tr": // Tree
                // Tile
                var grd = bg.createRadialGradient(this.x + TILE_DIM/2, this.y + TILE_DIM, 0, this.x + TILE_DIM/2, this.y + TILE_DIM, TILE_DIM);
                grd.addColorStop(0, COL_GRASS_DARK);
                grd.addColorStop(1, COL_GRASS);
                bg.fillStyle = grd
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);

                // Trunk
                bg.fillStyle = COL_BROWN_DARK;
                var n = 3 + parseInt(this.rng1 * 2);
                bg.fillRect(this.x + TILE_DIM/n, this.y + TILE_DIM/4, (1-2/n)*TILE_DIM, 3*TILE_DIM/4);

                // Leaves
                bg.fillStyle = this.getRGB();
                bg.beginPath();
                bg.arc(this.x + TILE_DIM/2, this.y + TILE_DIM/2, TILE_DIM/3 + this.rng2 * (TILE_DIM/2.5 - TILE_DIM/3), 0, 2*Math.PI);
                bg.fill();

                // More leaves
                bg.fillStyle = this.getRGB();
                bg.beginPath();
                bg.arc(this.x + TILE_DIM/4 + this.rng1*TILE_DIM/2, this.y + TILE_DIM/4 + this.rng2*TILE_DIM/4, TILE_DIM/4, 0, 2*Math.PI);
                bg.fill();

                // Fruit
                /*
                if (this.rng1 * this.rng2 > 0.5){
                    bg.fillStyle = COL_RED;
                    bg.beginPath();
                    bg.arc(this.x + TILE_DIM/3, this.y + 2*TILE_DIM/3, TILE_DIM/12, 0, 2*Math.PI);
                    bg.fill();
                    bg.fillStyle = COL_RED;
                    bg.beginPath();
                    bg.arc(this.x + 2*TILE_DIM/3, this.y + 2*TILE_DIM/3, TILE_DIM/12, 0, 2*Math.PI);
                    bg.fill();
                }
                */
                break;
            case "xx": // X marks the spot
                bg.fillStyle = COL_GRASS;
                bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
                bg.drawImage(imgX, 0, 0, TILE_DIM, TILE_DIM, this.x, this.y, TILE_DIM, TILE_DIM);
                break;
        }
        // Draw walk-over effect
        if (this.walkOverEffect){
            bg.globalAlpha = this.walkOverAlpha/100;
            bg.fillStyle = COL_RED;
            bg.fillRect(this.x, this.y, TILE_DIM, TILE_DIM);
            bg.globalAlpha = 1;
        }
    }

    // Set walk-over values
    this.walkOver = function(){
        this.walkOverStart  = true;
        this.walkOverEffect = true;
        this.walkOverAlpha  = 100;
    }

    // Return random color value given a range
    this.getRandomColorValue = function(v0, v1){
        return v0 + parseInt(Math.random() * (v1 - v0));
    }

    // Return RGB values
    this.getRGB = function(){
        return "rgb(" + this.r + "," + this.g + "," + this.b + ")";
    }

    // Clear tile
    this.clear = function(){
        bg.clearRect(this.x, this.y, TILE_DIM, TILE_DIM);
    }

    // Update tile
    this.update = function(){
        // Redraw
        if (this.redraw){
            // Check red value
            if (this.r == this.rt){
                this.rt = this.getRandomColorValue(this.r0, this.r1);
            } else if (this.r < this.rt){
                this.r++;
            } else if (this.r > this.rt){
                this.r--;
            }

            // Check green value
            if (this.g == this.gt){
                this.gt = this.getRandomColorValue(this.g0, this.g1);
            } else if (this.g < this.gt){
                this.g++;
            } else if (this.g > this.gt){
                this.g--;
            }

            // Check blue value
            if (this.b == this.bt){
                this.bt = this.getRandomColorValue(this.b0, this.b1);
            } else if (this.b < this.bt){
                this.b++;
            } else if (this.b > this.bt){
                this.b--;
            }
        }
        // Update walk-over values
        if (this.walkOverEffect){
            if (this.walkOverStart){
                this.walkOverStart = false;
            }
            else if (this.walkOverAlpha <= 0){
                this.walkOverAlpha = 0;
                this.walkOverEffect = false;
            } else {
                this.walkOverAlpha -= 4;
            }
        }
    }

    this.init();
}

// Initialize tiles
function initTiles(){
    tiles = [];
    for (var i=0; i<NUM_TILES; i++){
        tiles.push([]);
        for (var j=0; j<NUM_TILES; j++){
            var tile = new Tile(world.appearanceMap[i][j], world.interactionMap[i][j], i, j);
            tiles[i].push(tile);
        }
    }
}

// Draw tiles
function drawTiles(){
    for (var i=0; i<NUM_TILES; i++){
        for (var j=0; j<NUM_TILES; j++){
            tiles[i][j].draw();
        }
    }
}

// Update tiles
function updateTiles(){
    for (var i=0; i<NUM_TILES; i++){
        for (var j=0; j<NUM_TILES; j++){
            tiles[i][j].update();
        }
    }
}

// Clear tiles
function clearTiles(){
    for (var i=0; i<NUM_TILES; i++){
        for (var j=0; j<NUM_TILES; j++){
            tiles[i][j].clear();
        }
    }
}

// Return walkable status
function isWalkable(x, y){
    var val;
    if (x <= 0 || x >= STAGE_DIM || y <= 0 || y >= STAGE_DIM){
        val = true;
    } else {
        var i = parseInt(y / TILE_DIM);
        var j = parseInt(x / TILE_DIM);
        val = tiles[i][j].isWalkable;
    }
    return val;
}

// Return interaction code
function getCodeInteraction(x, y){
    var i = parseInt(y / TILE_DIM);
    var j = parseInt(x / TILE_DIM);
    return tiles[i][j].codeInteraction;
}

// Return interaction status
function isInteractive(x, y){
    var val;
    if (x <= 0 || x >= STAGE_DIM || y <= 0 || y >= STAGE_DIM){
        val = false;
    } else {
        val = getCodeInteraction(x, y) != 0;
    }
    return val;
}

/*
##################
###   Player   ###
##################
*/

function Player(iStart, jStart){
    // Initialize player
    this.init = function(){
        this.x             = jStart*TILE_DIM + TILE_DIM/2 - PLAYER_DIM/2;
        this.y             = iStart*TILE_DIM + TILE_DIM/2 - PLAYER_DIM/2;
        this.width         = PLAYER_DIM;
        this.height        = PLAYER_DIM;
        this.xSpeed        = 2;
        this.ySpeed        = 2;
        this.isMovingLeft  = false;
        this.isMovingRight = false;
        this.isMovingUp    = false;
        this.isMovingDown  = false;
        this.canInteract   = false;
        this.onTreasure    = false;
    }

    // Clear player
    this.clear = function(){
        fg.clearRect(0, 0, STAGE_DIM, STAGE_DIM);
    }

    // Draw player
    this.draw = function(){
        fg.fillStyle = COL_BLACK;
        fg.fillRect(this.x, this.y, this.width, this.height);
        fg.fillStyle = COL_WHITE;
        fg.fillRect(this.x + 2, this.y + 2, this.width - 4, this.height - 4);
    }

    // Update player
    this.update = function(){
        // Update position
        if (this.isMovingLeft){
            for (var i=this.xSpeed; i>0; i--){
                if (isWalkable(this.x - i, this.y) && isWalkable(this.x - i, this.y + this.height)){
                    this.x -= i;
                    break;
                }
            }
        }
        if (this.isMovingRight){
            for (var i=this.xSpeed; i>0; i--){
                if (isWalkable(this.x + this.width + i, this.y) && isWalkable(this.x + this.width + i, this.y + this.height)){
                    this.x += i;
                    break;
                }
            }
        }
        if (this.isMovingUp){
            for (var i=this.ySpeed; i>0; i--){
                if (isWalkable(this.x, this.y - i) && isWalkable(this.x + this.width, this.y - i)){
                    this.y -= i;
                    break;
                }
            }
        }
        if (this.isMovingDown){
            for (var i=this.ySpeed; i>0; i--){
                if (isWalkable(this.x, this.y + this.height + i) && isWalkable(this.x + this.width, this.y + this.height + i)){
                    this.y += i;
                    break;
                }
            }
        }

        // Update interactive status
        if (isInteractive(this.x + this.width/2, this.y + this.height/2)){
            this.canInteract = true;
            if (getCodeInteraction(this.x + this.width/2, this.y + this.height/2) == 63){
                this.onTreasure = true;
            } else {
                this.onTreasure = false;
                var i = parseInt((this.y + this.height/2) / TILE_DIM);
                var j = parseInt((this.x + this.width/2) / TILE_DIM);
                tiles[i][j].walkOver()
            }
        } else {
            this.canInteract = false;
            this.onTreasure  = false;
        }
    }

    this.init();
}

/*
##################
###   Clouds   ###
##################
*/

function Cloud(){
    // Initialize cloud
    this.init = function(){
        this.rng    = Math.random();
        this.scale  = 0.5 + Math.random();
        this.width  = this.scale * CLOUD_WIDTH;
        this.height = this.scale * CLOUD_HEIGHT;
        this.x      = (Math.random() * (STAGE_DIM + this.width)) - this.width;
        this.y      = (Math.random() * STAGE_DIM) - this.height/2;
        this.xSpeed = 0.25 + (0.75 * Math.random());
        this.alpha  = 0.75 + (0.25 * Math.random());
    }

    // Reset cloud
    this.reset = function(){
        this.rng    = Math.random();
        this.scale  = 0.5 + Math.random();
        this.width  = this.scale * CLOUD_WIDTH;
        this.height = this.scale * CLOUD_HEIGHT;
        this.x      = -this.width;
        this.y      = (Math.random() * STAGE_DIM) - this.height/2;
        this.xSpeed = 0.25 + (0.75 * Math.random());
        this.alpha  = 0.75 + (0.25 * Math.random());
    }

    // Draw cloud
    this.draw = function(){
        // Draw cloud itself
        var imgCloudsXPos;
        cg.globalAlpha = this.alpha;
        if (this.rng < 0.33){
            imgCloudsXPos = 0;
        } else if (this.rng < 0.66){
            imgCloudsXPos = 200;
        } else {
            imgCloudsXPos = 400;
        }
        cg.drawImage(imgClouds, imgCloudsXPos, 0, CLOUD_WIDTH, CLOUD_HEIGHT, this.x, this.y, this.width, this.height);

        // Draw cloud shadow
        sg.globalAlpha = this.alpha;
        sg.drawImage(imgCloudShadow, 0, 0, CLOUD_WIDTH, CLOUD_HEIGHT, this.x, this.y + 200, this.width, this.height);
    }

    // Update cloud
    this.update = function(){
        this.x += this.xSpeed;
        if (this.x >= STAGE_DIM){
            this.reset();
        }
    }

    this.init();
}

// Initialize clouds
function initClouds(){
    clouds = [];
    for (var i=0; i<NUM_CLOUDS; i++){
        var cloud = new Cloud();
        clouds.push(cloud);
    }
}

// Draw clouds
function drawClouds(){
    for (var i=0; i<NUM_CLOUDS; i++){
        clouds[i].draw();
    }
}

// Update clouds
function updateClouds(){
    for (var i=0; i<NUM_CLOUDS; i++){
        clouds[i].update();
    }
}

// Clear clouds
function clearClouds(){
    cg.clearRect(0, 0, STAGE_DIM, STAGE_DIM);
    sg.clearRect(0, 0, STAGE_DIM, STAGE_DIM);
}

/*
###################
###   Message   ###
###################
*/

function Message(){
    // Initialize message
    this.init = function(){
    }

    // Draw message
    this.draw = function(){
        // Draw half-transparent black background
        mg.globalAlpha = 0.5;
        mg.fillStyle = COL_BLACK;
        mg.fillRect(0, 0, STAGE_DIM, STAGE_DIM);

        // Draw white background
        mg.globalAlpha = 1;
        mg.fillStyle = COL_WHITE;
        mg.fillRect((STAGE_DIM - MESSAGE_WIDTH)/2, (STAGE_DIM - MESSAGE_HEIGHT)/2, MESSAGE_WIDTH, MESSAGE_HEIGHT);

        // Draw message image
        var i = parseInt((player.y + player.height/2) / TILE_DIM);
        var j = parseInt((player.x + player.width/2) / TILE_DIM);
        var imgMessagesYPos;
        switch (tiles[i][j].codeInteraction){
            case 11:
                imgMessagesYPos = 0;
                break;
            case 12:
                imgMessagesYPos = 200;
                break;
            case 13:
                imgMessagesYPos = 400;
                break;
            case 14:
                imgMessagesYPos = 600;
                break;
            case 21:
                imgMessagesYPos = 800;
                break;
            case 22:
                imgMessagesYPos = 1000;
                break;
            case 23:
                imgMessagesYPos = 1200;
                break;
            case 24:
                imgMessagesYPos = 1400;
                break;
            case 25:
                imgMessagesYPos = 1600;
                break;
            case 26:
                imgMessagesYPos = 1800;
                break;
            case 27:
                imgMessagesYPos = 2000;
                break;
            case 28:
                imgMessagesYPos = 2200;
                break;
            case 31:
                imgMessagesYPos = 2400;
                break;
            case 32:
                imgMessagesYPos = 2600;
                break;
            case 33:
                imgMessagesYPos = 2800;
                break;
            case 34:
                imgMessagesYPos = 3000;
                break;
            case 35:
                imgMessagesYPos = 3200;
                break;
            case 36:
                imgMessagesYPos = 3400;
                break;
            case 37:
                imgMessagesYPos = 3600;
                break;
            case 38:
                imgMessagesYPos = 3800;
                break;
            case 41:
                imgMessagesYPos = 4000;
                break;
            case 42:
                imgMessagesYPos = 4200;
                break;
            case 43:
                imgMessagesYPos = 4400;
                break;
            case 44:
                imgMessagesYPos = 4600;
                break;
            case 45:
                imgMessagesYPos = 4800;
                break;
            case 46:
                imgMessagesYPos = 5000;
                break;
            case 47:
                imgMessagesYPos = 5200;
                break;
            case 48:
                imgMessagesYPos = 5400;
                break;
            case 49:
                imgMessagesYPos = 5600;
                break;
            case 51:
                imgMessagesYPos = 5800;
                break;
            case 52:
                imgMessagesYPos = 6000;
                break;
            case 53:
                imgMessagesYPos = 6200;
                break;
            case 54:
                imgMessagesYPos = 6400;
                break;
            case 55:
                imgMessagesYPos = 6600;
                break;
            case 61:
                imgMessagesYPos = 6800;
                break;
            case 62:
                imgMessagesYPos = 7000;
                break;
            case 63:
                imgMessagesYPos = 7200;
                break;
            case 64:
                imgMessagesYPos = 7400;
                break;
            case 65:
                imgMessagesYPos = 7600;
                break;
            case 66:
                imgMessagesYPos = 7800;
                break;
        }
        mg.drawImage(imgMessages, 0, imgMessagesYPos, MESSAGE_WIDTH, MESSAGE_HEIGHT, (STAGE_DIM - MESSAGE_WIDTH)/2, (STAGE_DIM - MESSAGE_HEIGHT)/2, MESSAGE_WIDTH, MESSAGE_HEIGHT);
    }

    // Clear message
    this.clear = function(){
        mg.clearRect(0, 0, STAGE_DIM, STAGE_DIM);
    }

    this.init();
}

</script>

</body>
</html>
